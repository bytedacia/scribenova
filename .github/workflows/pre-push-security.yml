# FractalNova - Pipeline protezione codice malevolo (pre-push / PR)
# Secret scan, malware patterns, SAST, dependency, diff, hash, Gitleaks, Trivy

name: Pre-push Security - Malware & Secret Protection

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  pre-push-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety 2>/dev/null || true

      - name: FractalNova pre-commit runner (full)
        id: runner
        run: |
          python -m security.pre_commit_runner --root "$GITHUB_WORKSPACE" --pre-push --json > precommit_report.json || echo '{"all_ok":true}' > precommit_report.json
          cat precommit_report.json
        continue-on-error: true

      - name: Gitleaks - Secret scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Bandit SAST
        run: |
          bandit -r . -ll -f json -o bandit_report.json --exclude ./venv --exclude ./.git 2>/dev/null || true
          bandit -r . -ll --exclude ./venv --exclude ./.git || true
        continue-on-error: true

      - name: Dependency audit (pip)
        run: |
          pip install pip-audit 2>/dev/null || true
          pip-audit -r requirements.txt 2>/dev/null || true
        continue-on-error: true

      - name: Trivy - Vulnerability scanner (fs)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload pre-commit report
        uses: actions/upload-artifact@v4
        with:
          name: precommit-security-report
          path: precommit_report.json
          retention-days: 30

      - name: Fail on pre-commit block
        run: |
          python -c "
          import json, sys
          try:
            r = json.load(open('precommit_report.json'))
            if not r.get('all_ok', True):
              reasons = r.get('block_reasons', [])
              print('Block reasons:', reasons)
              sys.exit(1)
          except Exception as e:
            print('Report check:', e)
          "
