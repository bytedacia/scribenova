# FractalNova - Red Team Testing (schedulato + manuale)
# Esegue payload controllati e verifica detection. Solo in ambiente CI isolato.

name: Red Team - Detection Validation

on:
  schedule:
    - cron: '0 2 * * 1'   # Ogni lunedÃ¬ alle 2:00
  workflow_dispatch:

jobs:
  red-team-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || true

      - name: Run Red Team orchestrator
        id: redteam
        run: |
          python -m security.red_team.red_team_orchestrator --root "$GITHUB_WORKSPACE" || true
          echo "exit=$?" >> $GITHUB_OUTPUT

      - name: Analyze detection gaps
        run: |
          python -m security.red_team.analyze_detection_gaps

      - name: Upload Red Team report
        uses: actions/upload-artifact@v4
        with:
          name: red-team-report
          path: security/red_team/red_team_report.json
          retention-days: 90

      - name: Fail on critical bypass
        run: |
          python -c "
          import json, sys
          try:
            r = json.load(open('security/red_team/red_team_report.json'))
            bypassed = r.get('bypassed', 0)
            critical = [d for d in r.get('details', []) if d.get('critical') and d.get('blocked') is False]
            if critical:
              print('Critical payloads bypassed:', [d['payload_id'] for d in critical])
              sys.exit(1)
          except Exception as e:
            print('Check skipped:', e)
          "
